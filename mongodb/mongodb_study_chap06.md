#6. 집계
### 6장 주요 내용.
 - 전자상거래 데이터 모델 집계
 - 집계 프레임워크 상세
 - 성능 및 제한사항
 - 기타 집계 기능

이번 장에서는 MongoDB 집계 프레임워크(aggregation framework)를 사용하여 보다 복잡한 쿼리를 포함하도록 주제를 확장.
 - MongoDB의 고급 쿼리 언어.
 - 여러 도큐먼트의 데이터를 변환하고 결합하여 단일 도큐먼트에서 사용할 수 없는 새로운 정보를 생성할 수 있음.
	- ex) 월별 매출, 제품별 매출, 사용자별 주문 합계와 같은 것을 알아낼 수 있다.
	- 관계형 데이터베이스에 익숙한 사용자는 SQL의 GROUP BY 절과 동일하다고 생각할 수 있을 것임. 
 - 한번의 호출로 일련의 도큐먼트 작업을 정의한 다음 MongoDB에 배열의 형태로 보낼 수 있으므로 작업을 훨씬 쉽고 효율적으로 수행 가능.
 
## 6.1. 집계 프레임워크 개요.
 - 집계 프레임워크에 대한 호출은 파이프라인 각 단계에서의 출력이 다음 단계로의 입력으로 제공되는 파이프라인, 즉 집계 파이프라인(aggregation pipeline)을 정의함.
 - 각 단계는 입력을 변환하고 출력 도튜먼트를 생성하기 위해 입력 도큐먼트에 대해 단일 작업을 실행.
 - 집계 파이프라인 작업에는 다음이 포함된다.
	- $project - 출력 도큐먼트 상에 배치할 필드를 지정. (projected)
	- $match - 처리될 도큐먼트를 선택하는 것. find()와 비슷한 역할을 수행.
	- $limit - 다음 단계에 전달될 도큐먼트의 수를 제한.
	- $skip - 지정된 수의 도큐먼트를 건너뜀.
	- $unwind - 배열을 확장하여 각 배열 항목에 대해 하나의 출력 도큐먼트를 생성.
	- $group - 지정된 키로 도큐먼트를 그룹화.
	- $sort - 도큐먼트를 정렬한다.
	- $geoNear - 지리 공간위치 근처의 도큐먼트를 선택.
	- $out - 파이프라인의 결과(출력)를 컬렉션에 쓴다.
	- $redact - 특정 데이터에 대한 접근을 제어.

그림 6.1. 
<img src="/mongodb_img/mongodbinaction-image-6.1.png" />

> 대부분의 연산자는 익숙해 보이겠지만 집계 프레임워크 연산자는 MongoDB 쿼리에 사용되는 함수와 비슷하게 작동하므로 쿼리 언어를 잘 이해해야 한다.

- 코드 예제 : match, group, 및 sort로 구성된 집계 프레임워크 파이프라인 정의

~~~
db.products.aggregate([ {$match: ...}, {$group: ...}, {$sort: ...} ] )
~~~

그림 6.2. 
<img src="/mongodb_img/mongodbinaction-image-6.2.png" />

그림에서 알 수 있듯이 코드는 파이프라인을 정의
 - 전체 제품(products) 컬렉션은 $match 작업으로 전달되고, 입력된 컬렉션으로부터 오직 특정 도큐먼트만 선택한다.
 - $match의 출력은 $group 연산자로 전달되며, $group 연산자는 출력을 측정 키로 그룹화하여 합계 및 평균과 같은 새로운 정보를 제공한다.
 - $group 연산자의 출력은 마지막 단계인 $sort 연산자로 전달되어 정렬이 수행되고 그 뒤에 최종 결과로 반환된다.
 
> 표 6.1. SQL vs. 집계 프레임워크 비교

 |SQL 명령어|집계 프레임워크 연산자|
 |------|---|
 |SELECT| $project, $group 함수: $sum, $min, $avg 등|
 |FROM | db.collectionName.aggregate(...)|
 |JOIN | $unwind|
 |WHERE|$match|
 |GROUP BY|$group|
 |HAVING| $match|
 
 
 .. 작성중 ..
